---
# Copy packer and tofu files to inner PVE

# Packer files
- name: Create packer directory structure
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /root/packer
    - /root/packer/templates
    - /root/packer/scripts
    - /root/packer/cloud-init
    - /root/packer/images
    - /root/packer/logs
    - /root/packer/cache

- name: Copy packer templates
  ansible.builtin.copy:
    src: "{{ packer_src_dir }}/templates/"
    dest: /root/packer/templates/
    mode: '0644'

- name: Copy packer scripts
  ansible.builtin.copy:
    src: "{{ packer_src_dir }}/scripts/"
    dest: /root/packer/scripts/
    mode: '0755'

- name: Copy packer cloud-init files
  ansible.builtin.copy:
    src: "{{ packer_src_dir }}/cloud-init/"
    dest: /root/packer/cloud-init/
    mode: '0644'

- name: Copy packer build script
  ansible.builtin.copy:
    src: "{{ packer_src_dir }}/build.sh"
    dest: /root/packer/build.sh
    mode: '0755'

- name: Copy packer publish script
  ansible.builtin.copy:
    src: "{{ packer_src_dir }}/publish.sh"
    dest: /root/packer/publish.sh
    mode: '0755'

- name: Initialize packer plugins
  ansible.builtin.shell: |
    cd /root/packer/templates
    packer init debian-12-custom.pkr.hcl
  args:
    creates: /root/.config/packer/plugins

# Tofu files
- name: Create tofu directory structure
  ansible.builtin.file:
    path: /root/tofu
    state: directory
    mode: '0755'

- name: Sync tofu modules and environments
  ansible.posix.synchronize:
    src: "{{ tofu_src_dir }}/"
    dest: /root/tofu/
    rsync_opts:
      - "--exclude=.terraform"
      - "--exclude=terraform.tfstate*"
      - "--exclude=*.tfvars"
      - "--exclude=.terraform.lock.hcl"

- name: Generate terraform.tfvars for inner-test
  ansible.builtin.template:
    src: terraform.tfvars.j2
    dest: /root/tofu/envs/inner-test/terraform.tfvars
    mode: '0600'
  when: inner_pve_api_token is defined
