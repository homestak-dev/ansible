---
# Network bridge setup for inner PVE

- name: Get primary network interface
  ansible.builtin.shell: |
    set -o pipefail
    ip route | grep default | awk '{print $5}' | head -1
  args:
    executable: /bin/bash
  register: primary_iface_result
  changed_when: false

- name: Set primary interface fact
  ansible.builtin.set_fact:
    primary_iface: "{{ inner_pve_bridge_port | default(primary_iface_result.stdout | trim) }}"

- name: Get current IP address
  ansible.builtin.shell: |
    set -o pipefail
    ip -4 addr show {{ primary_iface }} | grep 'inet ' | awk '{print $2}' | head -1
  args:
    executable: /bin/bash
  register: current_ip_result
  changed_when: false

- name: Get current gateway
  ansible.builtin.shell: |
    set -o pipefail
    ip route | grep default | awk '{print $3}' | head -1
  args:
    executable: /bin/bash
  register: current_gw_result
  changed_when: false

- name: Display detected network config
  ansible.builtin.debug:
    msg: "Interface: {{ primary_iface }}, IP: {{ current_ip_result.stdout | trim }}, Gateway: {{ current_gw_result.stdout | trim }}"

- name: Check if vmbr0 already exists
  ansible.builtin.shell: ip link show vmbr0
  register: vmbr0_check
  failed_when: false
  changed_when: false

- name: Create vmbr0 bridge configuration
  ansible.builtin.template:
    src: interfaces.j2
    dest: /etc/network/interfaces
    backup: true
  vars:
    bridge_address: "{{ current_ip_result.stdout | trim }}"
    bridge_gateway: "{{ current_gw_result.stdout | trim }}"
    bridge_port: "{{ primary_iface | trim }}"
  when: vmbr0_check.rc != 0
  notify: Apply network configuration

- name: Flush handlers to apply network now
  ansible.builtin.meta: flush_handlers
