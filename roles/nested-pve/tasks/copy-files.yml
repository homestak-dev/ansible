---
# Setup homestak on nested PVE
# Two modes:
# - Production (bootstrap_use_local: false): Clone repos from GitHub via bootstrap
# - Dev (bootstrap_use_local: true): Sync local repos via tar/unarchive

# ============================================================================
# Common: Create base directories
# ============================================================================

- name: Create /opt/homestak directory
  ansible.builtin.file:
    path: /opt/homestak
    state: directory
    mode: '0755'

# ============================================================================
# Production mode: Use bootstrap installer
# ============================================================================

- name: Install homestak via bootstrap (production mode)
  when: not bootstrap_use_local
  block:
    - name: Run bootstrap installer
      ansible.builtin.shell: |
        curl -fsSL {{ bootstrap_url }} | HOMESTAK_BRANCH={{ bootstrap_branch }} bash
      args:
        creates: /opt/homestak/iac-driver/run.sh
      register: bootstrap_result

    - name: Show bootstrap output
      ansible.builtin.debug:
        var: bootstrap_result.stdout_lines
      when: bootstrap_result.changed

# ============================================================================
# Dev mode: Sync local repos via tar/unarchive
# ============================================================================

- name: Sync local repos (dev mode)
  when: bootstrap_use_local
  block:
    - name: Create repo directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /opt/homestak/tofu
        - /opt/homestak/packer
        - /opt/homestak/iac-driver
        - /opt/homestak/ansible
        - /opt/homestak/bootstrap

    # Tofu
    - name: Create local tar of tofu
      ansible.builtin.shell: >
        cd {{ homestak_src_dir }}/tofu &&
        tar --exclude='.git' --exclude='.terraform' --exclude='terraform.tfstate*'
        --exclude='.terraform.lock.hcl' --exclude='.states' -czf /tmp/homestak-tofu.tar.gz .
      delegate_to: localhost
      changed_when: true

    - name: Copy and extract tofu
      ansible.builtin.unarchive:
        src: /tmp/homestak-tofu.tar.gz
        dest: /opt/homestak/tofu/

    # Packer
    - name: Create local tar of packer
      ansible.builtin.shell: >
        cd {{ homestak_src_dir }}/packer &&
        tar --exclude='.git' --exclude='images' --exclude='logs' --exclude='cache' -czf /tmp/homestak-packer.tar.gz .
      delegate_to: localhost
      changed_when: true

    - name: Copy and extract packer
      ansible.builtin.unarchive:
        src: /tmp/homestak-packer.tar.gz
        dest: /opt/homestak/packer/

    # iac-driver
    - name: Create local tar of iac-driver
      ansible.builtin.shell: >
        cd {{ homestak_src_dir }}/iac-driver &&
        tar --exclude='.git' --exclude='__pycache__' --exclude='reports' --exclude='.states' -czf /tmp/homestak-iac-driver.tar.gz .
      delegate_to: localhost
      changed_when: true

    - name: Copy and extract iac-driver
      ansible.builtin.unarchive:
        src: /tmp/homestak-iac-driver.tar.gz
        dest: /opt/homestak/iac-driver/

    # Ansible
    - name: Create local tar of ansible
      ansible.builtin.shell: >
        cd {{ homestak_src_dir }}/ansible &&
        tar --exclude='.git' --exclude='*.retry' -czf /tmp/homestak-ansible.tar.gz .
      delegate_to: localhost
      changed_when: true

    - name: Copy and extract ansible
      ansible.builtin.unarchive:
        src: /tmp/homestak-ansible.tar.gz
        dest: /opt/homestak/ansible/

    # Bootstrap (for CLI)
    - name: Create local tar of bootstrap
      ansible.builtin.shell: >
        cd {{ homestak_src_dir }}/bootstrap &&
        tar --exclude='.git' -czf /tmp/homestak-bootstrap.tar.gz .
      delegate_to: localhost
      changed_when: true

    - name: Copy and extract bootstrap
      ansible.builtin.unarchive:
        src: /tmp/homestak-bootstrap.tar.gz
        dest: /opt/homestak/bootstrap/

    # Cleanup tar files
    - name: Cleanup local tar files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/homestak-tofu.tar.gz
        - /tmp/homestak-packer.tar.gz
        - /tmp/homestak-iac-driver.tar.gz
        - /tmp/homestak-ansible.tar.gz
        - /tmp/homestak-bootstrap.tar.gz
      delegate_to: localhost

    # Install dependencies (would be done by bootstrap in production)
    - name: Install IaC tools via ansible role
      ansible.builtin.include_role:
        name: homestak.debian.iac_tools

# ============================================================================
# Always: Sync site-config separately (contains secrets)
# ============================================================================

- name: Create site-config directory
  ansible.builtin.file:
    path: /opt/homestak/site-config
    state: directory
    mode: '0755'

- name: Create local tar of site-config
  ansible.builtin.shell: >
    cd {{ homestak_src_dir }}/site-config &&
    tar --exclude='.git' -czf /tmp/homestak-site-config.tar.gz .
  delegate_to: localhost
  changed_when: true

- name: Copy and extract site-config
  ansible.builtin.unarchive:
    src: /tmp/homestak-site-config.tar.gz
    dest: /opt/homestak/site-config/

- name: Cleanup site-config tar
  ansible.builtin.file:
    path: /tmp/homestak-site-config.tar.gz
    state: absent
  delegate_to: localhost

# ============================================================================
# Common: Packer setup (both modes, only if packer installed)
# ============================================================================

- name: Check if packer templates exist
  ansible.builtin.stat:
    path: /opt/homestak/packer/templates
  register: packer_templates

- name: Create packer working directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /opt/homestak/packer/images
    - /opt/homestak/packer/logs
    - /opt/homestak/packer/cache
  when: packer_templates.stat.exists

- name: Initialize packer plugins
  ansible.builtin.shell: |
    cd /opt/homestak/packer
    for template in templates/*/template.pkr.hcl; do
      packer init "$template"
    done
  args:
    creates: /root/.config/packer/plugins
  when: packer_templates.stat.exists

# ============================================================================
# Common: PVE configuration
# ============================================================================

- name: Enable snippets content type on local storage
  ansible.builtin.shell: |
    pvesm set local -content images,rootdir,vztmpl,backup,iso,snippets
  changed_when: false

- name: Regenerate PVE SSL certificates (IPv6 workaround)
  ansible.builtin.shell: |
    sysctl -w net.ipv6.conf.all.disable_ipv6=1
    sysctl -w net.ipv6.conf.default.disable_ipv6=1
    pvecm updatecerts --force 2>/dev/null || true
    sysctl -w net.ipv6.conf.all.disable_ipv6=0
    sysctl -w net.ipv6.conf.default.disable_ipv6=0
    systemctl restart pveproxy
  changed_when: false

# ============================================================================
# Common: API token and SSH key injection
# ============================================================================

- name: Delete existing tofu API token (if any)
  ansible.builtin.shell: |
    pveum user token remove root@pam tofu 2>/dev/null || true
  changed_when: false

- name: Create tofu API token
  ansible.builtin.shell: |
    pveum user token add root@pam tofu --privsep 0 --output-format json
  register: token_result

- name: Parse API token
  ansible.builtin.set_fact:
    pve_api_token: "{{ (token_result.stdout | from_json)['full-tokenid'] }}={{ (token_result.stdout | from_json).value }}"

- name: Update secrets.yaml with nested-pve token
  ansible.builtin.lineinfile:
    path: /opt/homestak/site-config/secrets.yaml
    regexp: '^(\s*)nested-pve:.*$'
    line: '    nested-pve: {{ pve_api_token }}'
  when: pve_api_token is defined

# Inject outer host's SSH key for jump chain verification
- name: Read outer host public key
  ansible.builtin.slurp:
    src: ~/.ssh/id_rsa.pub
  delegate_to: localhost
  register: outer_host_pubkey

- name: Inject outer host key into secrets.yaml ssh_keys
  ansible.builtin.lineinfile:
    path: /opt/homestak/site-config/secrets.yaml
    regexp: '^(\s*)outer_host:.*$'
    insertafter: '^ssh_keys:'
    line: '    outer_host: {{ outer_host_pubkey.content | b64decode | trim }}'
  when: outer_host_pubkey.content is defined
