---
# Sync homestak repos to /opt/homestak on nested PVE

- name: Create /opt/homestak directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /opt/homestak
    - /opt/homestak/site-config
    - /opt/homestak/tofu
    - /opt/homestak/packer
    - /opt/homestak/iac-driver

# Sync repos using tar + copy + unarchive (ansible.posix.synchronize not in ansible-core)
# Creates local tar, copies via ansible, extracts on target

- name: Create local tar of site-config
  ansible.builtin.shell: >
    cd {{ site_config_src_dir }} &&
    tar --exclude='.git' -czf /tmp/homestak-site-config.tar.gz .
  delegate_to: localhost
  changed_when: true

- name: Copy and extract site-config
  ansible.builtin.unarchive:
    src: /tmp/homestak-site-config.tar.gz
    dest: /opt/homestak/site-config/
    creates: /opt/homestak/site-config/site.yaml

- name: Create local tar of tofu
  ansible.builtin.shell: >
    cd {{ tofu_src_dir }} &&
    tar --exclude='.git' --exclude='.terraform' --exclude='terraform.tfstate*' --exclude='.terraform.lock.hcl' --exclude='.states' -czf /tmp/homestak-tofu.tar.gz .
  delegate_to: localhost
  changed_when: true

- name: Copy and extract tofu
  ansible.builtin.unarchive:
    src: /tmp/homestak-tofu.tar.gz
    dest: /opt/homestak/tofu/
    creates: /opt/homestak/tofu/envs

- name: Create local tar of packer
  ansible.builtin.shell: >
    cd {{ packer_src_dir }} &&
    tar --exclude='.git' --exclude='images' --exclude='logs' --exclude='cache' -czf /tmp/homestak-packer.tar.gz .
  delegate_to: localhost
  changed_when: true

- name: Copy and extract packer
  ansible.builtin.unarchive:
    src: /tmp/homestak-packer.tar.gz
    dest: /opt/homestak/packer/
    creates: /opt/homestak/packer/templates

- name: Create local tar of iac-driver
  ansible.builtin.shell: >
    cd {{ iac_driver_src_dir }} &&
    tar --exclude='.git' --exclude='__pycache__' --exclude='reports' --exclude='.states' -czf /tmp/homestak-iac-driver.tar.gz .
  delegate_to: localhost
  changed_when: true

- name: Copy and extract iac-driver
  ansible.builtin.unarchive:
    src: /tmp/homestak-iac-driver.tar.gz
    dest: /opt/homestak/iac-driver/
    creates: /opt/homestak/iac-driver/src

- name: Cleanup local tar files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/homestak-site-config.tar.gz
    - /tmp/homestak-tofu.tar.gz
    - /tmp/homestak-packer.tar.gz
    - /tmp/homestak-iac-driver.tar.gz
  delegate_to: localhost

# Create packer working directories
- name: Create packer working directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /opt/homestak/packer/images
    - /opt/homestak/packer/logs
    - /opt/homestak/packer/cache

# Initialize packer plugins (per-template directory structure)
- name: Initialize packer plugins
  ansible.builtin.shell: |
    cd /opt/homestak/packer
    for template in templates/*/template.pkr.hcl; do
      packer init "$template"
    done
  args:
    creates: /root/.config/packer/plugins

# Enable snippets on local datastore (required for cloud-init)
- name: Enable snippets content type on local storage
  ansible.builtin.shell: |
    pvesm set local -content images,rootdir,vztmpl,backup,iso,snippets
  changed_when: false

# Fix SSL certificates (IPv6 link-local addresses break cert generation)
- name: Regenerate PVE SSL certificates
  ansible.builtin.shell: |
    sysctl -w net.ipv6.conf.all.disable_ipv6=1
    sysctl -w net.ipv6.conf.default.disable_ipv6=1
    pvecm updatecerts --force 2>/dev/null || true
    sysctl -w net.ipv6.conf.all.disable_ipv6=0
    sysctl -w net.ipv6.conf.default.disable_ipv6=0
    systemctl restart pveproxy
  changed_when: false

# Create API token on inner PVE for tofu
# Delete and recreate to ensure we have the token value (only shown at creation)
- name: Delete existing tofu API token (if any)
  ansible.builtin.shell: |
    pveum user token remove root@pam tofu 2>/dev/null || true
  changed_when: false

- name: Create tofu API token
  ansible.builtin.shell: |
    pveum user token add root@pam tofu --privsep 0 --output-format json
  register: token_result

- name: Parse API token
  ansible.builtin.set_fact:
    pve_api_token: "{{ (token_result.stdout | from_json)['full-tokenid'] }}={{ (token_result.stdout | from_json).value }}"

# Update secrets.yaml with the actual API token
- name: Update secrets.yaml with nested-pve token
  ansible.builtin.lineinfile:
    path: /opt/homestak/site-config/secrets.yaml
    regexp: '^(\s*)nested-pve:.*$'
    line: '    nested-pve: {{ pve_api_token }}'
  when: pve_api_token is defined

# Inject outer host's SSH key for jump chain verification
# This enables SSH from outer PVE through inner PVE to test VMs
- name: Read outer host public key
  ansible.builtin.slurp:
    src: ~/.ssh/id_rsa.pub
  delegate_to: localhost
  register: outer_host_pubkey

- name: Inject outer host key into secrets.yaml ssh_keys
  ansible.builtin.lineinfile:
    path: /opt/homestak/site-config/secrets.yaml
    regexp: '^(\s*)outer_host:.*$'
    insertafter: '^ssh_keys:'
    line: '    outer_host: {{ outer_host_pubkey.content | b64decode | trim }}'
  when: outer_host_pubkey.content is defined
