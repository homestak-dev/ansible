---
# Install Proxmox VE on Debian 13 Trixie
# Reference: https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_13_Trixie
#
# Two paths:
# 1. Fast path (~2 min): Pre-installed PVE packages (debian-13-pve image)
#    - Detected by /etc/pve-packages-preinstalled marker file
#    - Only needs kernel switch and reboot
# 2. Full install (~20 min): Fresh Debian 13
#    - Downloads and installs all PVE packages

- name: Verify running on Debian Trixie
  ansible.builtin.assert:
    that:
      - ansible_distribution == "Debian"
      - ansible_distribution_major_version == "13" or ansible_distribution_release == "trixie"
    fail_msg: "This playbook requires Debian 13 (Trixie)"

- name: Configure hostname and /etc/hosts
  ansible.builtin.include_tasks: hostname.yml

- name: Check for pre-installed PVE packages marker
  ansible.builtin.stat:
    path: /etc/pve-packages-preinstalled
  register: pve_preinstalled_marker

- name: Display installation path
  ansible.builtin.debug:
    msg: "{{ 'Fast path: PVE packages pre-installed, switching kernel' if pve_preinstalled_marker.stat.exists else 'Full install: Installing PVE from scratch' }}"

# Fast path: kernel switch only (debian-13-pve image)
- name: Kernel switch for pre-installed packages
  ansible.builtin.include_tasks: kernel-switch.yml
  when: pve_preinstalled_marker.stat.exists

# Full install path: fresh Debian 13
- name: Full PVE installation
  ansible.builtin.include_tasks: install.yml
  when: not pve_preinstalled_marker.stat.exists

# Common cleanup for both paths
- name: Post-install cleanup
  ansible.builtin.include_tasks: cleanup.yml

- name: Display completion message
  ansible.builtin.debug:
    msg: |
      Proxmox VE installation complete!
      Access web interface at: https://{{ pve_ip }}:8006

      Next steps:
      1. Create Linux Bridge vmbr0 for VM networking
      2. Configure storage as needed
      3. Run pve-setup.yml for post-install configuration
