---
# Kernel switch for pre-installed PVE packages
# Used when booting from debian-13-pve packer image

- name: Remove pre-installed marker file
  ansible.builtin.file:
    path: /etc/pve-packages-preinstalled
    state: absent

- name: Get root filesystem device
  ansible.builtin.shell: |
    set -o pipefail
    findmnt -n -o SOURCE / | sed 's/[0-9]*$//'
  args:
    executable: /bin/bash
  register: root_device
  changed_when: false

- name: Pre-configure grub-pc install devices
  ansible.builtin.debconf:
    name: grub-pc
    question: grub-pc/install_devices
    value: "{{ root_device.stdout }}"
    vtype: string

- name: Get PVE kernel version
  ansible.builtin.shell: |
    set -o pipefail
    dpkg -l | grep 'proxmox-kernel-[0-9]' | awk '{print $2}' | head -1 | sed 's/proxmox-kernel-//'
  args:
    executable: /bin/bash
  register: pve_kernel
  changed_when: false

- name: Set PVE kernel as default in grub
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_DEFAULT='
    line: 'GRUB_DEFAULT="Advanced options for Debian>Debian GNU/Linux, with Linux {{ pve_kernel.stdout }}"'
  notify: Reboot for new kernel

- name: Update grub configuration
  ansible.builtin.command: update-grub
  changed_when: true

- name: Flush handlers to reboot now
  ansible.builtin.meta: flush_handlers

- name: Wait for system to come back after reboot
  ansible.builtin.wait_for_connection:
    delay: 30
    timeout: "{{ reboot_timeout }}"

- name: Verify running on PVE kernel
  ansible.builtin.shell: uname -r
  register: running_kernel
  changed_when: false

- name: Assert PVE kernel is active
  ansible.builtin.assert:
    that:
      - "'pve' in running_kernel.stdout"
    fail_msg: "Expected PVE kernel but running {{ running_kernel.stdout }}"
    success_msg: "Successfully booted into PVE kernel {{ running_kernel.stdout }}"
