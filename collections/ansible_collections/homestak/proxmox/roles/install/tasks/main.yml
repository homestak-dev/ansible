---
# Install Proxmox VE on Debian 13 Trixie
# Reference: https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_13_Trixie
#
# This wrapper runs both phases with ansible.builtin.reboot between them.
# Works for remote mode where the reboot module can reconnect via SSH.
#
# For local mode, use kernel.yml and packages.yml separately with
# scenario-managed reboot (see iac-driver pve-setup scenario).

- name: "Phase 1: Install Proxmox kernel"
  ansible.builtin.include_tasks: kernel.yml

- name: Reboot for new kernel
  ansible.builtin.reboot:
    reboot_timeout: "{{ reboot_timeout }}"
    msg: "Rebooting to load Proxmox kernel"

- name: Wait for system to come back after reboot
  ansible.builtin.wait_for_connection:
    delay: 30
    timeout: "{{ reboot_timeout }}"

- name: "Phase 2: Install PVE packages"
  ansible.builtin.include_tasks: packages.yml
